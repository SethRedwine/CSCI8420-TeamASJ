# Code Analysis for Software Security Engineering
## TeamASJY

### Code Review Strategy

For the code review of Mailpile, we decided to use both an automated and manual analysis approach. The automated code review was performed using the Bandit and Pylint analysis tools and the entire codebase of Mailpile was scanned. These tools were mainly used to identify potential security concerns and general flaws with the source code that could cause problems with the software. For the manual code review, we decided to follow a checklist-based approach working through the list of threats we identified from our data flow diagrams and the problems found by the automated tooling. Once flaws were found, they were categorized based on the CWE that they describe. Both the automated and manual code review process was focused on finding potential security flaws based on the requirements that we have outlined in our misuse cases, assurance cases, and threat models.

### Automated Code Review

The reports generated by the scanning tools are available at the links below. As mentioned before, both Bandit and Pylint were used for automatic analysis. Bandit is a tool that is mainly focused on finding security vulnerabilities within Python code. Pylint can also be used to find common security vulnerabilities but it is mainly used to find general errors within Python code.

#### Bandit Findings

One of the most common low severity potential vulnerabilities found by Bandit is the use of standard pseudo-random number generators. Bandit warns that these types of generators "are not suitable for security/cryptographic purposes". Most of these occur in modules that do not provide core security functions, but these could still create vulnerabilities if cracked. Another commmon low severity vulnerability is catching all exceptions instead of catching specific ones. There are quite a few instances of "Try, Except, Pass" blocks being used. Instead of looking for specific exceptions and handling each one appropriately, all exceptions are being caught and simply ignored. This can cause some security issues since there is no way to tell exactly which errors are occurring within these blocks. The next concern is the use of subprocesses within some source modules. These subprocesses are being used without any sort of input validation. For example, there is a subprocess in the file tor.py within the crypto module, and there is no input validation performed on the results of that subprocess. This could allow untrusted or unsecure data to enter the main process. The most concerning and highest severity issue that Bandit detected was the use of an insecure hashing function within a key lookup program. Within wkd.py, the SHA-1 hash function is being used. This hashing function has been proven to be unsecure and easy to break. A secure alternative would be to use an algorithm such as BCrypt.

#### Pylint Findings

Pylint did not detect very many actual security concerns within Mailpile since it is mainly focused on code quality checking. However, some security information can be extracted from the results. For example, Pylint detected that there were some sections of code that were marked as needing fixing, but were never fixed. For example, in auth.py, the developers flagged portions of code that need fixes such as implement password salting, needing CSRF protection, and possibly changing how an HTTP request is being sent. In the latest version of the source, these issues have not yet been addressed. Most of the issues they have marked for fixing are pretty significant from a security perspective and should be dealt with as soon as possible. Pylint also found a very large number of bad coding practices such as unused variables, unused functions, assertions in production code, and a bad coding style in general. This can be concerning as it implies a lack of a solid engineering process which could lead to some unexpected behaviors that could negatively impact the application's security.

#### Report Links

[Bandit Scan Report](https://github.com/SethRedwine/CSCI8420-TeamASJY/blob/master/CodeAnalysis/Reports/BanditReport.txt)

[Pylint Scan Report](https://github.com/SethRedwine/CSCI8420-TeamASJY/blob/master/CodeAnalysis/Reports/PylintReport.txt)

### Manual Code Review

Based on the analysis of the data flow diagram we developed, we identified the four most relevant common weaknesses to look for as we reviewed the codebase. After reviewing the code base, we found three of these represented represented which are discussed further in the Summary of Key Findings section.

#### Manual Code Review Checklist:

- [X] CWE-20: Improper Input Validation
- [] CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')
- [X] CWE-250: Execution with Unnecessary Privileges
- [X] CWE-284: Improper Access Control

### Summary of Key Findings

The security vulnerabilities found in the manual and automated code reviews can be categorized into known security threats provided by the Common Weakness Enumeration (CWE). The following CWEs were determined to be present and relevant based on the review findings.

#### [CWE-20: Improper Input Validation](https://cwe.mitre.org/data/definitions/20.html)
The manual code review showed that Mailpile uses [validators.py](https://github.com/mailpile/Mailpile/blob/master/mailpile/config/validators.py) to validate most input with regards to email addresses, URL's, directories, and more. These are read in from a config file. The input being read in from the config files is not being checked or validated. This could allow attackers the ability to craft an unexpected input which could result in malicious use of the program.

#### [CWE-250: Execution with Unnecessary Privileges](https://cwe.mitre.org/data/definitions/250.html)

The automated code review showed that there are a few scenarios in which subprocesses are being generated and used without any input validation. This could potentially cause operations that have a higher privilege level than necessary to be executed. If this is allowed to happen, new weaknesses can be created or existing weaknesses can be amplified. This threat was also identified within the threat model where data being sent between the keystores and the main application might not be getting validated.

This weakness was also discovered in the manual code review process. In the source module that handles communications with the Tor web browser, a subprocess is created and used for password hashing. However, there is no input validation or other security checks performed on this subprocess after the data has been transferred.

#### [CWE-284: Improper Access Control](https://cwe.mitre.org/data/definitions/284.html)

When reviewing the code manually, we found a potential issue with the timeout for the user's session. The user session that Mailpile creates in [auth.py](https://github.com/mailpile/Mailpile/blob/master/mailpile/auth.py) remains open for a week by default and isn't configurable, allowing the program to be left open to unauthorized users for quite a long period. This weakens the argument we made in our first assurance claim. It was also apparent in the same file that the developers had coded in a default user for development purposes (the application is still in beta) that would allow access to the application without actually performing any authentication, which poses a large risk for people that would choose to use the application before that is taken out.

#### [CWE-327: Use of a Broken or Risky Cryptographic Algorithm](https://cwe.mitre.org/data/definitions/327.html)

As found by the automated code review, there is an instance of the unsecure SHA-1 hashing algorithm being used within a key lookup function. It has been shown that this algorithm is not secure and using it is an unneccessary risk that can lead to sensitive information being exposed. This vulnerability was also discussed within our misuse cases where an attacker might be able to gain access to sensitive information. It is recommended that the software be designed where the cryptographic algorithm can be replaced easily. This makes it easier to switch to more up-to-date algorithms as they become available.

#### [CWE-338: Use of Cryptographically Weak Pseudo-Random Number Generator](https://cwe.mitre.org/data/definitions/338.html)

As noted in the automated code review section, there are many instances of standard pseudo-random number generators being used for cryptographic purposes. These types of generators should not be used for cryptography as they can expose the cryptography to certain types of attacks. The CWE description explains that these types of weak generators do not utilize the entropy sources of a system. A consequence of doing this is that an attacker may be able to easily guess the number generated by the weak generator and gain access to restricted functionality. In order to mitigate this concern, a hardware-based random number generator function should be used.

#### [CWE-396: Declaration of Catch for Generic Exception](https://cwe.mitre.org/data/definitions/396.html)

This CWE reflects the use of the "Try, Except, Pass" blocks within some of the source modules as shown in the automated code review. The practice of catching all exceptions can lead to very complex error handling code which will likely include security vulnerabilities. Another consequence of this is that as the application grows, new exception types may be introduced. Since these blocks are catching all exceptions and not doing any error handling, a new exception type that needs to be handled a certain way will be not be processed correctly. There might also be some exceptions that shouldn't be caught at all, which will be caught in the current implementation.

#### [CWE-601: URL Redirection to Untrusted Site ('Open Redirect')](https://cwe.mitre.org/data/definitions/601.html)

The automated code scan also detected some audit URLs being open for permitted schemes. If this is exploited by an attacker, malicious data could be uploaded into the application. Since an HTTP parameter may contain a URL value, this could cause the web application to redirect the request to the specified URL. By modifying the URL value to a malicious site, an attacker may successfully launch a phishing scam and steal user credentials. Because the server name in the modified link is identical to the original site, phishing attempts have a more trustworthy appearance. In this case, a specified URL format should be utilized.

### Project Interaction Links

We opened issue #2181 on Mailpile's GitHub repository. This issue advises them that the use of SHA-1 for hashing is not recommended since it is an outdated algorithm. The issue can be found at the following link.

[GitHub Issue](https://github.com/mailpile/Mailpile/issues/2181)

### Project Task Board

[Github Project Page](https://github.com/SethRedwine/CSCI8420-TeamASJY/projects/6)
